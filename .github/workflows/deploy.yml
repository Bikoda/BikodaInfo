name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build application
      run: npm run build
      
    - name: Create static export for deployment
      run: |
        mkdir -p public
        cp -r .next/server/app/* public/
        mkdir -p public/_next/static
        cp -r .next/static/* public/_next/static/
        
        # Fix asset paths in HTML files to use relative paths
        find public -name "*.html" -exec sed -i 's|href="/_next/static/|href="./_next/static/|g' {} \;
        find public -name "*.html" -exec sed -i 's|src="/_next/static/|src="./_next/static/|g' {} \;
        
        # Fix asset paths in JavaScript files to use relative paths
        find public -name "*.js" -exec sed -i 's|"/_next/static/|"./_next/static/|g' {} \;
        find public -name "*.js" -exec sed -i 's|/_next/static/|./_next/static/|g' {} \;
        
        # Fix asset paths in RSC files to use relative paths
        find public -name "*.rsc" -exec sed -i 's|"/_next/static/|"./_next/static/|g' {} \;
        find public -name "*.rsc" -exec sed -i 's|/_next/static/|./_next/static/|g' {} \;
        
        # Additional fixes for webpack and other references
        find public -name "*.js" -exec sed -i 's|s\.p="/_next/"|s.p="./_next/"|g' {} \;
        find public -name "*.js" -exec sed -i 's|s\.miniCssF=function\(e\){return"static/css/|s.miniCssF=function(e){return"./_next/static/css/|g' {} \;
        
        echo "Static export created successfully!"
        echo "Contents of public directory:"
        ls -la public/
        echo "Contents of public/_next/static:"
        ls -la public/_next/static/
      
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './public'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
